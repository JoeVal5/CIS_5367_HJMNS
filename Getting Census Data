## https://api.census.gov/data/2020/acs/acs5/variables.html lists all the possible variable keys for the API Request
## Below provides a DF with the ZIP Code and the Median household income.
## Need to initialize spark session first
##CODE
import requests
from pyspark.sql.types import *
from pyspark.sql.functions import from_json
import pandas as pd
from pyspark.sql.functions import col


variables = 'B19013_001E'
year = 2012
key  = '46d133e794f5998e012ea4e0d83d6fb6085136b0'
geography = 'zip%20code%20tabulation%20area'
start_year = 2012
end_year = 2020


while year != end_year + 1:
  census_API_call = requests.get(f'https://api.census.gov/data/{year}/acs/acs5?get={variables}&for={geography}:*&key={key}')
  census_JSON = census_API_call.json()
  df = pd.DataFrame(census_JSON[1:], columns = census_JSON[0])
  #print(df)
  sparkDF = spark.createDataFrame(df)
  #sparkDF.show()
  if year == start_year:
    updated_df = sparkDF.select(col("B19013_001E").alias("Median_Inc_2012"),col("zip code tabulation area").alias("Zip_Code") )
  else:
    column_title = f"Median_Inc_{year}"
    updated_df = updated_df.join(sparkDF,sparkDF['zip code tabulation area']== updated_df.Zip_Code,'left').select(updated_df ["*"],sparkDF['B19013_001E'].alias(column_title))
  
  #print(year)
  year += 1

updated_df.show()
